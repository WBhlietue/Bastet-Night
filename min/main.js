const ctx=Get("b").getContext("2d"),bgCtx=Get("a").getContext("2d");ctx.imageSmoothingEnabled=!1,ctx.mozImageSmoothingEnabled=!1,ctx.webkitImageSmoothingEnabled=!1,ctx.msImageSmoothingEnabled=!1;var pause=!0,tPause=!1;const w=640,h=360,objects=[],monsters=[];let score=0,canSelect=!1,point=0,panel=Get("p"),upgrades={speed:0,atk:0,hp:0,hpReg:0,range:0};const up=[0,1,2,3,4].flatMap((e=>new Array(10).fill(e))),price=[1,2,3,5,8,13,21,34,55];function clamp(e,t,s){return Math.min(Math.max(e,t),s)}let chig=[0,0];function Get(e){return document.getElementById(e)}function Dis(e,t){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))}function IsCol(e,t,s=1){return!(e.x+e.size*s<t.x||e.x>t.x+t.size*s||e.y+e.size*s<t.y||e.y>t.y+t.size*s)}function RefreshUpgrade(){for(let e=1;e<4;e++){const t=Get("y"+e),s=Rand(up.length);switch(t.value=s,up[s]){case 0:t.innerHTML="Speed++<br><br><br>Point:"+10*price[upgrades.speed];break;case 1:t.innerHTML="Atk++<br><br><br>Point:"+10*price[upgrades.atk];break;case 2:t.innerHTML="HP++<br><br><br>Point:"+10*price[upgrades.hp];break;case 3:t.innerHTML="HP Regen++<br><br><br>Point:"+10*price[upgrades.hpReg];break;case 4:t.innerHTML="Range++<br><br><br>Point:"+10*price[upgrades.range];break}}}Get("h").innerHTML="High score: "+(null==localStorage.getItem("score",0)?0:localStorage.getItem("score")),RefreshUpgrade();class Obj{x=0;y=0;anim=0;imgs=[];flip=!1;a=0;animTarget=1;animInterval=200;interval;size=32;hp=10;maxHp=10;constructor(e){e.map((e=>{const t=new Image;t.src=`./${e}.png`,this.imgs.push(t)}))}Init(){this.interval=setInterval((()=>{pause||tPause||(this.a=(this.a+1)%this.animTarget)}),this.animInterval),objects.push(this)}Render(){let e=this.size,t=e/2;ctx.save(),this.flip?(ctx.translate(this.x+t,this.y+t),ctx.scale(-1,1),ctx.drawImage(this.imgs[this.anim],-t,-t,e,e)):ctx.drawImage(this.imgs[this.anim],this.x,this.y,e,e),ctx.restore()}Update(){}Remove(){objects.splice(objects.indexOf(this),1),clearInterval(this.interval)}After(){ctx.fillStyle="red",ctx.fillRect(this.x,this.y-5,this.size,3),ctx.fillStyle="green",ctx.fillRect(this.x,this.y-5,this.size*(this.hp/this.maxHp),3)}}class Player extends Obj{animTarget=4;Update(){if(0==chig[0]&&0==chig[1])this.anim=0;else{let e=this.x,t=this.y;this.x=clamp(this.x+chig[0]*(2+.2*upgrades.speed),0,w-32),this.y=clamp(this.y+chig[1]*(2+.2*upgrades.speed),0,h-32),IsCol(this,house,.9)&&(this.x=e,this.y=t),0!=chig[0]&&(this.flip=chig[0]<0),this.anim=this.a}}}function Rand(e){return Math.round(Math.random()*e)}function Clear(){ctx.clearRect(0,0,w,h)}function SetHP(){let e=house.maxHp-house.hp;house.maxHp=100+10*upgrades.hp,house.hp=house.maxHp-e}function PlayerAtk(){const e=new Obj(["atk1","atk2","atk3","atk4","atk5"]);e.x=player.x+(player.flip?-1:1)*(Rand(20)+20+2*upgrades.range),e.y=player.y-2.5*upgrades.range,e.flip=player.flip,e.animInterval=50,e.animTarget=5,e.size=32+6*upgrades.range,zzfx(...[,,860,.03,.01,.31,4,1.7,,,,,,,,,,.77,,.02]),e.Update=()=>{e.anim=e.a,monsters.map((t=>{IsCol(e,t)&&(t.iFrame||(t.hp-=upgrades.atk+1,t.iFrame=!0,t.hp<=0&&(point+=t.num,monsters.splice(monsters.indexOf(t),1),t.Remove(),zzfx(...[1.8,,425,.02,.01,.16,3,.1,,,,,,1.4,,.2,.1,.67,.01,,381]),score++,score>localStorage.getItem("score")&&localStorage.setItem("score",score),10==score&&setInterval((()=>{pause||tPause||SpawnMonster(1,3,"monster1",1,.5)}),5e3),20==score&&setInterval((()=>{pause||tPause||SpawnMonster(1,5,"monster2",1,1)}),5e3),50==score&&setInterval((()=>{pause||tPause||SpawnMonster(2,7,"monster3",2,.5)}),5e3),75==score&&setInterval((()=>{pause||tPause||SpawnMonster(2.5,3,"monster4",3,.5)}),5e3),100==score&&setInterval((()=>{pause||tPause||SpawnMonster(1.5,20,"monster5",5,1)}),5e3)),setTimeout((()=>{t.iFrame=!1}),300)))}))},e.After=()=>{},setTimeout((()=>{e.Remove()}),250),e.Init()}function SpawnMonster(e,t,s,a,n){const i=new Obj([s]);Rand(2);1==Rand(2)?(i.x=Rand(w),i.y=0==Rand(2)?-32:h+32):(i.x=0==Rand(2)?-32:w+32,i.y=Rand(h)),i.num=a,i.rate=n,i.hp=t,i.maxHp=t,i.iFrame=!1,i.counter=0,i.Update=()=>{if(IsCol(i,house))i.counter+=1,i.counter>=60&&(house.hp--,zzfx(...[1.5,,494,,.02,.08,1,3.8,,-4,,,,1.3,,.4,,.62,.05,,1610]),house.hp<=0&&GameOver(),i.counter=0);else{i.counter=0;let t=(house.x-i.x)/Dis(i,house),s=(house.y-i.y)/Dis(i,house);i.x+=t*e,i.y+=s*e}},monsters.push(i),i.Init()}function GameOver(){pause=!0,zzfx(...[1.2,,489,,.04,.26,1,2.1,-4,,278,.09,.07,,,.1,,.66,.01]),Get("o").style.display="flex",Get("o1").innerHTML="current score: "+score,Get("o2").innerHTML="high score: "+localStorage.getItem("score")}function Resize(){let e,t=window.innerWidth,s=window.innerHeight,a=Get("c"),n=1;e=s/h*w,n=e<t?e/w:t/w,a.style.transform=" scale("+n+")  translateX(-50%)"}Get("l").addEventListener("click",(()=>{pause=!1,Get("s").style.display="none",Music(),setInterval(Music,5440)}));const player=new Player(["cat1","cat2","cat1","cat3"]);player.After=()=>{},player.Init(),player.x=200,player.y=150;const house=new Obj(["house"]);house.size=100,house.maxHp=100,house.hp=100,house.x=270,house.y=110,house.Init();const keys={};function Select(e){if(!canSelect)return;let t=Get("y"+e).value;const s=10*price[upgrades[Object.keys(upgrades)[up[t]]]];s>point||(canSelect=!1,point-=s,upgrades[Object.keys(upgrades)[up[t]]]+=1,up.splice(t,1),panel.style.display="none",pause=!1,RefreshUpgrade(),SetHP())}function Init(){RefreshUpgrade(),Resize(),setInterval((()=>{pause||tPause||SpawnMonster(1,3,"monster1",1,.5)}),5e3),setInterval((()=>{pause||tPause||(house.hp+=upgrades.hpReg,house.hp>house.maxHp&&(house.hp=house.maxHp))}),1e4),document.addEventListener("keydown",(e=>{keys[e.key]||" "!=e.key||PlayerAtk(),keys[e.key]||"f"!=e.key||(panel.style.display="flex",pause=!0,canSelect=!0),keys[e.key]||"Escape"!=e.key||(panel.style.display="none",pause=!1,canSelect=!1),keys[e.key]||"1"!=e.key||Select(1),keys[e.key]||"2"!=e.key||Select(2),keys[e.key]||"3"!=e.key||Select(3),keys[e.key]=!0})),document.addEventListener("keyup",(e=>{keys[e.key]=!1}));for(let e=0;e<160;e++)for(let t=0;t<90;t++)bgCtx.fillStyle=`hsl(115, 100%, ${5*Math.random()+30}%)`,bgCtx.fillStyle=`hsl(51, 60%, ${5*Math.random()+30}%)`,bgCtx.fillRect(5*e,5*t,5,5)}function Input(){chig=[0,0],keys.w&&(chig[1]=-1),keys.a&&(chig[0]=-1),keys.s&&(chig[1]=1),keys.d&&(chig[0]=1)}function Render(){objects.map((e=>{e.Update(),e.Render()})),objects.map((e=>{e.After()}))}function Update(){pause||tPause||(Clear(),Input(),Render(),Get("d").innerHTML="Score: "+score),Get("e").innerHTML="Point: "+point,requestAnimationFrame(Update)}function Music(){with(new AudioContext)with(G=createGain())for(i in D=[12,15,15,13,9,11,11,,7,11,11,9,4,7,7,,4,7,7,,9,11,11,,5,8,10,15,13,10,13,,13,10,13])with(createOscillator())D[i]&&(connect(G),G.connect(destination),start(.15*i),frequency.setValueAtTime(200*1.06**(13-D[i]),.15*i),type="triangle",gain.setValueAtTime(.5,.15*i),gain.setTargetAtTime(1e-4,.15*i+.13,.005),stop(.15*i+.14))}Init(),Update();